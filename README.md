## ソースコードについて

  XML形式の特許文書データを分析するためのサンプルコードです。

## 準備

  ```
    $ sudo apt update
    $ sudo apt install python3-dev python3-pip
    $ sudo apt install libatlas-base-dev        # required for numpy
    $ sudo pip3 install -U virtualenv 
  ```

  ```
    $ virtualenv --system-site-packages -p python3 ./venv
    $ source ./venv/bin/activate
    $ pip install --upgrade pip
    $ deactivate
  ```

  ```
    $ pip install mca numpy scipy pandas
  ```

  以下、お好みで。

  ```
    $ pip install matplotlib scikit-learn tensorflow
  ```

## 使用する文書

  下記URLからダウンロードした特許文書を使用します。

  https://www.publication.jpo.go.jp/index.action

## ダウンロードしたファイルの例（一部抜粋）

  ```
          :
    <technical-field>
    <p num="0001">
      本発明は、移動無線の基地局または端末、衛星通信および放送システムに用いられる....。<br/>
          :
    </technical-field>
          :
  ```

## 主に使うツール

  分析に使用するツールを紹介します。

### コマンド

  - python3

  - chmod
  
  - cat
  
  - find
  
  - grep
  
  - cut

  - sed

  - awk

  - ls

  - pwd

  - cd

  - xargs

  - paste

#### UNIXコマンド使用例
  
  JPH_2018042 ディレクトリに含まれている、拡張子が pdf のファイルのファイルサイズの合計を計算する例です。

  ```bash
    $ find JPH_2018042 -name '*.pdf' -exec ls -l {} \; | cut -d' ' -f 7 | awk '{sum+=$1}END{print sum}'
  ```

### Pythonプログラム

  - readdir.py

    ディレクトリの中にある、指定した拡張子のファイルのリストを作成。
    拡張子は引数で指定可。

    find . -name '*.xml' と同意。

    ```
      $ ./readdir.py xml ./[ディレクトリ]
    ```

    実行例

    ```
      $ ./readdir.py xml ./JPH_2018042/
      ./JPH_2018042/DOCUMENT/B9/0006409001/0006409201/0006409211/0006409217.xml
      ./JPH_2018042/DOCUMENT/B9/0006409001/0006409901/0006409981/0006409984.xml
          :
    ```

  - xml2json.py (*.xml => *.json)

    xmlファイルをjson形式に変換

    ```
      $ ./readdir.py xml ./[ディレクトリ] | ./xml2json.py
    ```

    変換結果は、入力ファイルと同じ場所に、拡張子 .json で保存される。

    XMLファイルから以下のタグを抜き出す。

    - tech-problem
    - background-art
    - technical-field
    - tech-solution
    - description-of-drawings
    - description-of-embodiments
    - reference-signs-list
    - claim-text

    実行例

    ```
      $ ./readdir.py xml ./JPH_2018042/ | ./xml2json.py
      ./JPH_2018042/DOCUMENT/B9/0006409001/0006409201/0006409211/0006409217.json
      ./JPH_2018042/DOCUMENT/B9/0006409001/0006409901/0006409981/0006409984.json
          :
    ```

    出力ファイル例

    ```
      {
        "tech-problem": "上記のように、.....",
        "background-art": "本発明は、...",
        "technical-field": "本発明は、...",
        "description-of-drawings": "図１は、...",
        "description-of-embodiments": "本発明に関わる...",
        "reference-signs-list": "...",
        "claim-text": "ベースバンド変調信号の..."
      }
    ```

  - mecab.py (*.json => *.mecab)

    json形式になったデータに含まれる文字列を形態素解析する。

    実行には mecab コマンドが必要。

    ```
      $ ./readdir.py json ./[ディレクトリ] | ./mecab.py
    ```

    変換結果は、入力ファイルと同じ場所に、拡張子 .mecab で保存される。

    実行例

    ```
      $ ./readdir.py json ./JPH_2018042/ | ./mecab.py
      ./JPH_2018042/DOCUMENT/B9/0006409001/0006409201/0006409211/0006409217.mecab
      ./JPH_2018042/DOCUMENT/B9/0006409001/0006409901/0006409981/0006409984.mecab
          :
    ```

    出力ファイル例

    ```
      上記	名詞,一般,*,*,*,*,上記,ジョウキ,ジョーキ
      の	助詞,連体化,*,*,*,*,の,ノ,ノ
      よう	名詞,非自立,助動詞語幹,*,*,*,よう,ヨウ,ヨー
      に	助詞,副詞化,*,*,*,*,に,ニ,ニ
          :
    ```

  - frequency.py (*.mecab => *.freq/*.gfrq)

    文書に含まれている単語の頻度リストを作成する。

    ```
      $ ./readdir.py mecab ./[ディレクトリ] | ./frequency.py
    ```

    変換結果は、入力ファイルと同じ場所に、拡張子 .freq で保存される。

    全ファイルの集計データは、 /tmp/frequency.gfrq に保存される。引数を指定すると保存先を変更できる。

    ```
      $ ./readdir.py mecab ./[ディレクトリ] | ./frequency.py alldata.gfrq
    ```

    実行例

    ```
      $ ./readdir.py mecab ./JPH_2018042/ | ./frequency.py
      ./JPH_2018042/DOCUMENT/B9/0006409001/0006409201/0006409211/0006409217.freq
      ./JPH_2018042/DOCUMENT/B9/0006409001/0006409901/0006409981/0006409984.freq
          :
    ```

    出力ファイル例

    ```
      、	1195	0.06728603603603604	記号
      の	880	0.04954954954954955	助詞
      信号	783	0.04408783783783784	名詞
      １	633	0.03564189189189189	名詞
      ２	575	0.03237612612612613	名詞
      と	558	0.03141891891891892	助詞
          :
    ```

    単語、回数、tf値、品詞のタブ区切りの文字列

    ※ tf値 = その単語のそのドキュメントでの出現回数 / そのドキュメントで出現したすべての単語の総数

  - calc-tfidf.py ( *.freq/ *.gfrq => *.tfidf)

    頻度データから TF-IDF 値を計算する。

    tfidfの計算には、/tmp/frequency.gfrq が必要なため、一度、frequency.pyを実行した後、calc-tfidf.pyを実行する。

    実行例

    ```
      $./readdir.py mecab ./JPH_2018042/ | ./frequency.py
      ./JPH_2018042/0006409217.freq
      ./JPH_2018042/0006409984.freq
      ./JPH_2018042/0006410188.freq
      ./JPH_2018042/0006411382.freq
      ./JPH_2018042/0006411893.freq
          :
      $./readdir.py freq ./JPH_2018042/ | ./calc-tfidf.py
      ./JPH_2018042/0006409217.tfidf
      ./JPH_2018042/0006409984.tfidf
      ./JPH_2018042/0006410188.tfidf
      ./JPH_2018042/0006411382.tfidf
      ./JPH_2018042/0006411893.tfidf
          :
    ```

    出力ファイル例

    ```
      信号	783	0.11674370061130163	3.302585092994046	0.38555600533984463	名詞
      送信	249	0.037125391382138065	2.6094379124341005	0.09687640378650529	名詞
      支援	218	0.03250335470404055	2.6094379124341005	0.08481548604601669	名詞
      機	248	0.03697629342478008	2.203972804325936	0.08149474511299122	名詞
      電力	240	0.035783509765916204	2.203972804325936	0.07886588236741085	名詞
          :
    ```

    先頭から、単語、出現回数、TF値、IDF値、TF-IDF値、品詞。

  - ngram.py (*.mecab => *.*gram)

    文書に含まれている単語のnグラムリストを作成する。N値のデフォルトは2。

    ```
      $ ./readdir.py mecab ./[ディレクトリ] | ./ngram.py
    ```

    変換結果は、入力ファイルと同じ場所に、拡張子 .2gram で保存される。

    N値は引数で変更できる。

    ```
      $ ./readdir.py mecab ./[ディレクトリ] | ./ngram.py 3
    ```

    上記の場合、変換結果は、入力ファイルと同じ場所に、拡張子 .3gram で保存される。

    実行例

    ```
      $ ./readdir.py mecab ./JPH_2018042/ | ./ngram.py 3
      ./JPH_2018042/DOCUMENT/B9/0006409001/0006409201/0006409211/0006409217.3gram
      ./JPH_2018042/DOCUMENT/B9/0006409001/0006409901/0006409981/0006409984.3gram
          :
    ```

    出力ファイル例

    ```
      複合	送信	機	150
      支援	信号	の	97
      主	信号	の	78
          :
    ```

  - top-ngram.py (*.*gram => 標準出力)

    上位の単語を抜き出してタブ区切りのCSV形式で出力する。単語は「/」区切りで連結される。

    ```
      $ ./readdir.py 2gram ./[ディレクトリ] | ./top-ngram.py [抜き出す上位N文字] [含まれている文字]
    ```

    [抜き出す上位N文字]で取り出したい文字の数を指定できる。省略すると30文字。
    [含まれている文字]を指定すると、その文字が含まれているファイルのみ出力する。

    実行例

    ```
      $ ./readdir.py 2gram ./JPH_2018042/ | ./top-ngram.py 5
      ./JPH_2018042/0006409217.2gram	送信/機	支援/信号	主/信号	複合/送信	電力/増幅器	包絡/線
      ./JPH_2018042/0006409984.2gram	弁/部	シール/部	弁/体	縁/部	収容/部	部/収容
      ./JPH_2018042/0006410188.2gram	腐植/酸	複合/体	酸/複合	鉄/腐植	電子/伝達	電子/供与
      ./JPH_2018042/0006411382.2gram	斜視/図	大腿/骨	リボン/状	装置/斜視	第/装置	腱/取付
          :
    ```

  - top-words.py (*.tfidf => 標準出力)

    tfidf上位の単語を抜き出して一覧表にする。

    ```
      $ ./readdir.py tfidf ./[ディレクトリ] | ./top-words.py [抜き出す上位N文字] [含まれている文字]
    ```

    [抜き出す上位N文字]で取り出したい文字の数を指定できる。省略すると30文字。
    [含まれている文字]を指定すると、その文字が含まれているファイルのみ出力する。

    実行例

    ```
      $ ./readdir.py tfidf ./JPH_2018042/ | ./top-words.py 5
      ./JPH_2018042/0006409217.tfidf	信号	送信	支援	機	電力	増幅器
      ./JPH_2018042/0006409984.tfidf	弁	部	吸気	シール	ハウジング	縁
      ./JPH_2018042/0006410188.tfidf	腐植	電子	鉄	微生物	複合	酸
      ./JPH_2018042/0006411382.tfidf	骨	腱	脛骨	斜視	大腿	装置
          :
    ```

  - top-tfidf.py (*.tfidf => 標準出力)

    tfidf上位の単語を抜き出して、文字数、TF-IDF値を含めて一覧表にする。

    ```
      $ ./readdir.py tfidf ./[ディレクトリ] | ./top-tfidf.py [抜き出す上位N文字] [含まれている文字]
    ```

    [抜き出す上位N文字]で取り出したい文字の数を指定できる。省略すると30文字。
    [含まれている文字]を指定すると、その文字が含まれているファイルのみ出力する。

    実行例

    ```
      $ ./readdir.py tfidf ./JPH_2018042/ | ./top-tfidf.py 3
      ./JPH_2018042/0006409217.tfidf	信号(783,0.38555600533984463)	送信(249,0.09687640378650529)	支援(218,0.08481548604601669)
      ./JPH_2018042/0006409984.tfidf	弁(87,0.16223879338818858)	部(181,0.12500789541946467)	吸気(66,0.12307770532897065)
      ./JPH_2018042/0006410188.tfidf	腐植(252,0.11677444134060609)	電子(275,0.10068688451233024)	鉄(247,0.09043512899834752)
      ./JPH_2018042/0006411382.tfidf	骨(39,0.06853069264978445)	腱(30,0.0667188907675565)	脛骨(28,0.062270964716386046)
          :
    ```

    出力結果の()の中の数値は、(出現回数, TF-IDF値)。

  - co-occurrence.py (top-words.py => 標準出力)

    共起テーブルを作成する。

    実行例

    ```
      $ ./readdir.py tfidf ./JPH_2018042/ | ./top-words.py | ./co-occurrence.py
      物	化合	4
      物	性	3
      化合	性	3
      前記	部	2
      前記	送信	2
      前記	機	2
      部	状	2
    ```

  - cross-tfidf.py (top-words.py / top-tfidf.py => 標準出力)

    TF-IDFのクロス集計を行う。

    ```
      $ ./readdir.py tfidf ./[ディレクトリ] | ./top-tfidf.py | ./cross-tfidf.py [共起している回数]
    ```

    [共起している回数]を指定すると、異なるファイルに指定した回数以上出現した単語だけ集計する。デフォルトは2。

    実行例

    top-tfidf.py の出力を入力に繋ぐと、TF-IDF値をクロス集計する。

    ```
      $ ./readdir.py tfidf ./JPH_2018042/ | ./top-tfidf.py 5 | ./cross-tfidf.py 2
        送信	シール	光
      ./JPH_2018042/0006409217.tfidf	0.09687640378650529	0	0
      ./JPH_2018042/0006409984.tfidf	0	0.06925103437854474	0
      ./JPH_2018042/0006410188.tfidf	0	0	0
          :
    ```

    top-words.py の出力を入力に繋ぐと、出現したかどうかを示すの0/1値をクロス集計する。1が含まれている、0が含まれていないを意味する。

    ```
      $ ./readdir.py tfidf ./JPH_2018042/ | ./top-words.py 5 | ./cross-tfidf.py 2
        送信	シール	光
      ./JPH_2018042/0006409217.tfidf	1	0	0
      ./JPH_2018042/0006409984.tfidf	0	1	0
      ./JPH_2018042/0006410188.tfidf	0	0	0
          :
    ```

  - cross-count.py (top-ngram.py / top-words.py / top-tfidf.py => 標準出力)

    文字数のクロス集計を行う。

    ```
      $ ./readdir.py tfidf ./[ディレクトリ] | ./top-tfidf.py | ./cross-count.py [共起している回数]
    ```

    [共起している回数]を指定すると、異なるファイルに指定した回数以上出現した単語だけ集計する。デフォルトは2。

    実行例

    top-tfidf.py の出力を入力に繋ぐと、TF-IDF値をクロス集計する。

    ```
      $ ./readdir.py tfidf ./JPH_2018042/ | ./top-tfidf.py 5 | ./cross-count.py 2
        送信	シール	光
      ./JPH_2018042/0006409217.tfidf	249	0	0
      ./JPH_2018042/0006409984.tfidf	0	47	0
      ./JPH_2018042/0006410188.tfidf	0	0	0
        :
    ```

    top-words.py の出力を入力に繋ぐと、出現したかどうかを示すの0/1値をクロス集計する。1が含まれている、0が含まれていないを意味する。

    ```
      $ ./readdir.py tfidf ./JPH_2018042/ | ./top-words.py 5 | ./cross-count.py 2
        送信	シール	光
      ./JPH_2018042/0006409217.tfidf	1	0	0
      ./JPH_2018042/0006409984.tfidf	0	1	0
      ./JPH_2018042/0006410188.tfidf	0	0	0
          :
    ```

  - coressp-analysis.py (cross-tfidf.py => 標準出力)

    対応分析を行う。

    実行例

    ```
      $ ./readdir.py tfidf ./JPH_2018042/ | ./top-tfidf.py | ./cross-tfidf.py | ./coressp-analysis.py 
      0006409217.tfidf	-0.6648901553984891	1.1232943547029592
      0006409984.tfidf	-1.1717637684915905	-1.0615124142476513
      0006410188.tfidf	0.516438001581472	0.10101242162872236
      0006411382.tfidf	-0.7214362539231878	-1.1796216799050439
          :

      前記	-0.4913340670353276	1.1185125769480315
      部	-1.1573028109940138	-0.9195108769644732
      物	1.1053169981547994	-0.2901934889289371
      化合	1.1295766101354086	-0.26751985267725564
          :
    ```

  - coressp-sort.py (coressp-analysis.py => 標準出力)

    対応分析の結果を指定したキーに近い順に並べかえる。

    実行例

    ```
      $ ./readdir.py tfidf ./JPH_2018042/ | ./top-tfidf.py | ./cross-tfidf.py | ./coressp-analysis.py | ./coressp-sort.py 0006411893.tfidf
      0006411893.tfidf	1.1954429856018303	-0.7754237779673789
      0006413010.tfidf	1.2914730629284286	-0.6156001748682306
      0006410188.tfidf	0.516438001581472	0.10101242162872236
      0006413009.tfidf	0.8812942583491514	0.3368825334323084
          :
      
      投与	1.335085870672188	-0.8639635652941883
      ｍｇ	1.349127811091992	-0.8382526456734829
      治療	1.3684337892775233	-0.8029032254019582
      用量	1.3706696590465755	-0.7988093276787229
          :
    ```

  - principal-comp.py

    主成分分析を行う。

    実行例

    ```
      $ ./principal-comp.py ./data.csv
      0	0.846734198299	-0.18480343217
      1	-0.709667935431	-0.317515142735
      2	-0.137066262869	0.502318574905
    ```

    または、

    ```
      $ echo ./data.csv | ./principal-comp.py
      0	0.846734198299	-0.18480343217
      1	-0.709667935431	-0.317515142735
      2	-0.137066262869	0.502318574905
    ```

    入力ファイルの例

    ```
    A	1.2	0
    B	0	1
    C	0	0
    ```

    入力ファイルの1列目はインデックス。
